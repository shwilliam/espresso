<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <title>☕☕☕☕</title>
  <script src='https://d3js.org/d3.v5.min.js'></script>
</head>

<body>
  <div id='coffee-shop'></div>

  <script type='text/javascript'>
    const coffeeData = [
      {
        name: 'Espresso',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,  // bottom -> top
          },
        ]
      },
      {
        name: 'Café au lait',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'steamed milk',
            percent: 60,
            order: 2,
          },
          {
            name: 'milk foam',
            percent: 10,
            order: 3,
          },
        ]
      },
      {
        name: 'Cappuccino',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'steamed milk',
            percent: 30,
            order: 2,
          },
          {
            name: 'milk foam',
            percent: 40,
            order: 3,
          },
        ]
      },
      {
        name: 'Caffé Americano',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'hot water',
            percent: 70,
            order: 2,
          },
        ]
      },
      {
        name: 'Long Black',
        parts: [
          {
            name: 'hot water',
            percent: 60,
            order: 1,
          },
          {
            name: 'espresso',
            percent: 40,
            order: 2,
          },
        ]
      },
      {
        name: 'Espresso Macchiato',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'milk foam',
            percent: 15,
            order: 2,
          },
        ]
      },
      {
        name: 'Caffé Mocha',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'chocolate syrup',
            percent: 15,
            order: 2,
          },
          {
            name: 'steamed milk',
            percent: 30,
            order: 3,
          },
          {
            name: 'whipped cream',
            percent: 25,
            order: 4,
          },
        ]
      },
      {
        name: 'Flat White',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'steamed milk',
            percent: 70,
            order: 2,
          },
        ]
      },
      {
        name: 'Espresso con Panna',
        parts: [
          {
            name: 'espresso',
            percent: 30,
            order: 1,
          },
          {
            name: 'whipped cream',
            percent: 40,
            order: 2,
          },
        ]
      },
    ]

    const drinkWidth = 260
    const drinkHeight = 160

    const ingredientColors = {
      fill: '#FFFFFF',
      espresso: '#4E2A2A',
      'steamed milk': '#F5E4C0',
      'milk foam': '#FCF6EA',
      'hot water': '#ADD8E6',
      'whipped cream': '#FFFFCC',
      'chocolate syrup': '#2B1D0E',
    }

    const cupPath = 'M1,1c0,0 0,58.318 0,101.32c0,11.934 4.741,23.38 13.18,31.819c8.439,8.44 19.885,13.181 31.82,13.181c37.992,0 92.118,0 130.11,0c11.935,0 23.381,-4.741 31.82,-13.181c8.439,-8.439 13.18,-19.885 13.18,-31.819c0,-43.002 0,-101.32 0,-101.32'
    const lidPath = 'M1,2.001l220.11,0'
    const handlePath = 'M221.766,1.998c19.841,0 35.949,16.108 35.949,35.949c0,19.841 -16.108,35.949 -35.949,35.949c-19.841,0 -35.949,-16.108 -35.949,-35.949c0,-19.841 16.108,-35.949 35.949,-35.949Zm0,17.975c9.92,0 17.974,8.054 17.974,17.974c0,9.92 -8.054,17.974 -17.974,17.974c-9.92,0 -17.974,-8.054 -17.974,-17.974c0,-9.92 8.054,-17.974 17.974,-17.974Z'

    coffeeData.forEach((coffee) => {
      let totalPercent = 0
      let maxOrderInt = 0
      coffee.parts.forEach((part) => {
        totalPercent += part.percent
        if (part.order > maxOrderInt) maxOrderInt = part.order
      })
      coffee.parts.push({
        name: 'fill',
        percent: 100 - totalPercent,
        order: maxOrderInt + 1
      })
    })

    coffeeData.forEach((coffee) => {
      let totalPercent = 0
      coffee.layers = []
      coffee.parts.sort((a, b) => b.order - a.order)
      coffee.parts.forEach((part) => {
        part.startPercent = totalPercent
        coffee.layers.push({
          percent: totalPercent,
          color: ingredientColors[part.name],
        })
        totalPercent += part.percent
        part.endPercent = totalPercent
        coffee.layers.push({
          percent: totalPercent,
          color: ingredientColors[part.name],
        })
      })
    })

    const container = d3.select('#coffee-shop')

    const svg = container.append('svg')
      .attr('width', drinkWidth)
      .attr('height', drinkHeight * coffeeData.length)

    const margin = {
      top: 20, right: 20, bottom: 20, left: 20,
    }

    const width = +svg.attr('width') - margin.left - margin.right

    const height = +svg.attr('height') - margin.top - margin.bottom

    const drinkTransition = 2000

    const drink = svg
      .selectAll('.coffee')
      .data(coffeeData)
      .enter()
      .append('g')
      .attr('class', 'coffee')
      .attr('transform', (d, i) => `translate(0,${i * drinkHeight})`)

    drink
      .append('path')
      .attr('d', cupPath)
      .attr('stroke-width', '2px')
      .style('stroke', '#FFFFFF')
      .style('fill', (d, i) => 'url(#grad' + i + ')')
      .transition()
      .duration(drinkTransition)
      .style('stroke', '#000000')

    drink
      .append('path')
      .attr('d', lidPath)
      .attr('stroke-width', '2px')
      .style('stroke', '#FFFFFF')
      .transition()
      .duration(drinkTransition)
      .style('stroke', '#000000')

    drink
      .append('clipPath')
      .attr('id', (d, i) => `clip${i}`)
      .append('rect')
      .attr('x', 222.1)
      .attr('y', -0.459)
      .attr('width', 38.149)
      .attr('height', 77.41)

    drink
      .append('g')
      .attr('clip-path', (d, i) => `url(#clip${i})`)
      .append('path')
      .attr('d', handlePath)
      .attr('stroke-width', '2px')
      .style('stroke', '#FFFFFF')
      .style('fill', 'none')
      .transition()
      .duration(drinkTransition)
      .style('stroke', '#000000')

    const gradient = svg.append('defs')
      .selectAll('linearGradient')
      .data(coffeeData)
      .enter()
      .append('linearGradient')
      .attr('id', (d, i) => 'grad' + i)
      .attr('x1', '0%')
      .attr('x2', '0%')
      .attr('y1', '0%')
      .attr('y2', '100%')

    const color = gradient.selectAll('.color')
      .data(d => d.layers)
      .enter()
      .append('stop')
      .attr('offset', '100%')
      .style('stop-color', d => d.color)
      .transition()
      .duration(2000)
      .attr('offset', d => d.percent + '%')
  </script>
</body>

</html>